var mojoHtml5Gl=function(){function r(t){var n=false;if(typeof window.ActiveXObject!="undefined")try{var r=new ActiveXObject("ChromeTab.ChromeFrame");if(r){try{var i=document.createElement("canvas");var s=i.getContext("webgl")||i.getContext("experimental-webgl");n=typeof s!=="undefined"&&s!==null}catch(o){}}}catch(o){}if(navigator.userAgent.indexOf("MSIE")<0||n){if(!n&&navigator.userAgent.indexOf("Opera")>=0)try{new e(document.createElement("canvas"))}catch(o){return}new e(document.getElementById(t))}else{var u=document.createElement("object");u.onreadystatechange=function(){try{var n=u.getContext("webgl");n.readPixels(0,0,i.width,i.height,n.RGBA,n.UNSIGNED_BYTE,new Uint8Array(i.width*i.height*4))}catch(r){return}var i=document.getElementById(t);var s=document.createElement("object");s.onreadystatechange=function(){new e(s)};i.parentNode.replaceChild(s,i);s.id=t;s.width=i.width;s.height=i.height;s.type="application/x-webgl"};u.type="application/x-webgl"}}document.addEventListener("DOMContentLoaded",function(){r("GameCanvas")},false);var e=this.WebGL2D=function(t){this.canvas=t;this.gl=undefined;this.fs=undefined;this.vs=undefined;this.shaderProgram=undefined;this.shaderPool=[];this.maxTextureSize=undefined;this.width;this.height;t.gl2d=this;var r=this.gl=t.getContext("webgl",{alpha:false})||t.getContext("experimental-webgl",{alpha:false});if(typeof r==="undefined"||r===null)return;try{this.initShaders()}catch(i){throw i}t.getContext=function(e){return function(t){return new n(e)}}(this)};var t={texture:1,crop:2};e.prototype.getFragmentShaderSource=function(n){var r=[];r.push("precision mediump float;","varying vec4 vColor;");if(n&t.texture){r.push("varying vec2 vTextureCoord;","uniform sampler2D uSampler;")}r.push("void main(void) {");if(n&t.texture){r.push("gl_FragColor = texture2D(uSampler, vTextureCoord) * vColor;")}else{r.push("gl_FragColor = vColor;")}r.push("}");return r.join("\n")};e.prototype.getVertexShaderSource=function(n){var r=2/this.canvas.width,i=-2/this.canvas.height;var s=[];s.push("attribute vec4 aVertexPosition;","attribute vec4 aVertexColor;","varying vec4 vColor;","const mat4 pMatrix = mat4("+r+",0,0,0, 0,"+i+",0,0, 0,0,1.0,1.0, -1.0,1.0,0,0);");if(n&t.texture){s.push("varying vec2 vTextureCoord;")}s.push("void main(void) {","vec3 position = vec3(aVertexPosition.x, aVertexPosition.y, 1.0);","gl_Position = pMatrix * vec4(position, 1.0);","vColor = aVertexColor;");if(n&t.texture){s.push("vTextureCoord = aVertexPosition.zw;")}s.push("}");return s.join("\n")};e.prototype.initShaders=function(t){var n=this.gl;t=t||0;var r=this.shaderPool;if(!r){r=this.shaderPool=[]}r=r[t];if(r){n.useProgram(r);this.shaderProgram=r;return r}else{var i=this.fs=n.createShader(n.FRAGMENT_SHADER);n.shaderSource(this.fs,this.getFragmentShaderSource(t));n.compileShader(this.fs);if(!n.getShaderParameter(this.fs,n.COMPILE_STATUS)){throw"fragment shader error: "+n.getShaderInfoLog(this.fs)}var s=this.vs=n.createShader(n.VERTEX_SHADER);n.shaderSource(this.vs,this.getVertexShaderSource(t));n.compileShader(this.vs);if(!n.getShaderParameter(this.vs,n.COMPILE_STATUS)){throw"vertex shader error: "+n.getShaderInfoLog(this.vs)}var o=this.shaderProgram=n.createProgram();n.attachShader(o,i);n.attachShader(o,s);n.linkProgram(o);if(!n.getProgramParameter(o,n.LINK_STATUS)){throw"Could not initialise shaders."}n.useProgram(o);o.vertexPositionAttribute=n.getAttribLocation(o,"aVertexPosition");n.enableVertexAttribArray(o.vertexPositionAttribute);o.vertexColorAttribute=n.getAttribLocation(o,"aVertexColor");n.enableVertexAttribArray(o.vertexColorAttribute);o.uColor=n.getUniformLocation(o,"uColor");o.uSampler=n.getUniformLocation(o,"uSampler");o.uCropSource=n.getUniformLocation(o,"uCropSource");this.shaderPool[t]=o;return o}};var n=this.WebGL2DAPI=function(n){function E(e,t){if(g.vcount+t>i||y.next===s){S()}y.last=b[y.next];y.next+=1;y.last.type=e;y.last.count=t;y.last.texture=null;g.vpointer=g.vcount*4;g.cpointer=g.vcount*4;g.vcount+=t;var n=g.cpointer;for(var r=0;r<t;r++){g.cdata[n]=o;g.cdata[n+1]=u;g.cdata[n+2]=a;g.cdata[n+3]=f;n+=4}}function S(){if(g.vcount===0)return;var e=n.shaderProgram;var i=null;var s=0;var o;switch(p){case c:e=n.initShaders(0);r.bindBuffer(r.ARRAY_BUFFER,g.vbuffer);r.bufferData(r.ARRAY_BUFFER,g.vdata,r.DYNAMIC_DRAW);r.vertexAttribPointer(e.vertexPositionAttribute,4,r.FLOAT,false,0,0);r.bindBuffer(r.ARRAY_BUFFER,g.cbuffer);r.bufferData(r.ARRAY_BUFFER,g.cdata,r.DYNAMIC_DRAW);r.vertexAttribPointer(e.vertexColorAttribute,4,r.FLOAT,false,0,0);for(var u=0;u<y.next;u++){o=b[u];r.drawArrays(o.type,s,o.count);s+=o.count}break;case h:e=n.initShaders(t.texture);r.bindBuffer(r.ARRAY_BUFFER,g.vbuffer);r.bufferData(r.ARRAY_BUFFER,g.vdata,r.DYNAMIC_DRAW);r.vertexAttribPointer(e.vertexPositionAttribute,4,r.FLOAT,false,0,0);r.bindBuffer(r.ARRAY_BUFFER,g.cbuffer);r.bufferData(r.ARRAY_BUFFER,g.cdata,r.DYNAMIC_DRAW);r.vertexAttribPointer(e.vertexColorAttribute,4,r.FLOAT,false,0,0);for(var u=0;u<y.next;u++){o=b[u];if(i!==o.texture){r.bindTexture(r.TEXTURE_2D,o.texture);r.activeTexture(r.TEXTURE0);r.uniform1i(e.uSampler,0);i=o.texture}r.drawArrays(o.type,s,o.count);s+=o.count}break}x()}function x(){g.vcount=0;y.next=0;p=c}function T(e,t,n,i){E(r.TRIANGLE_FAN,4);var s=e,o=e+n,u=e+n,a=e;var f=t,l=t,c=t+i,h=t+i;if(d.tformed){var p=s,v=o,m=u,y=a;s=p*d.ix+f*d.jx+d.tx;f=p*d.iy+f*d.jy+d.ty;o=v*d.ix+l*d.jx+d.tx;l=v*d.iy+l*d.jy+d.ty;u=m*d.ix+c*d.jx+d.tx;c=m*d.iy+c*d.jy+d.ty;a=y*d.ix+h*d.jx+d.tx;h=y*d.iy+h*d.jy+d.ty}var b=g.vpointer;g.vdata[b]=s;g.vdata[b+1]=f;g.vdata[b+2]=0;g.vdata[b+3]=0;g.vdata[b+4]=o;g.vdata[b+5]=l;g.vdata[b+6]=1;g.vdata[b+7]=0;g.vdata[b+8]=u;g.vdata[b+9]=c;g.vdata[b+10]=1;g.vdata[b+11]=1;g.vdata[b+12]=a;g.vdata[b+13]=h;g.vdata[b+14]=0;g.vdata[b+15]=1}function N(e,t,n,i,s,o,u,a){E(r.TRIANGLE_FAN,4);var f=e,l=e+n,c=e+n,h=e;var p=t,v=t,m=t+i,y=t+i;if(d.tformed){var b=f,w=l,S=c,x=h;f=b*d.ix+p*d.jx+d.tx;p=b*d.iy+p*d.jy+d.ty;l=w*d.ix+v*d.jx+d.tx;v=w*d.iy+v*d.jy+d.ty;c=S*d.ix+m*d.jx+d.tx;m=S*d.iy+m*d.jy+d.ty;h=x*d.ix+y*d.jx+d.tx;y=x*d.iy+y*d.jy+d.ty}var T=g.vpointer;g.vdata[T]=f;g.vdata[T+1]=p;g.vdata[T+2]=s;g.vdata[T+3]=o;g.vdata[T+4]=l;g.vdata[T+5]=v;g.vdata[T+6]=u;g.vdata[T+7]=o;g.vdata[T+8]=c;g.vdata[T+9]=m;g.vdata[T+10]=u;g.vdata[T+11]=a;g.vdata[T+12]=h;g.vdata[T+13]=y;g.vdata[T+14]=s;g.vdata[T+15]=a}function C(e){this.obj=r.createTexture();this.index=m.push(this);v.push(e);this.width=e.meta_width;this.height=e.meta_height;var t=typeof CFG_MOJO_IMAGE_FILTERING_ENABLED==="undefined"||CFG_MOJO_IMAGE_FILTERING_ENABLED==="true"||CFG_MOJO_IMAGE_FILTERING_ENABLED==="1";if(e.width>n.maxTextureSize||e.height>n.maxTextureSize){var i=document.createElement("canvas");i.width=e.width>n.maxTextureSize?n.maxTextureSize:e.width;i.height=e.height>n.maxTextureSize?n.maxTextureSize:e.height;var s=i.getContext("2d");s.drawImage(e,0,0,e.width,e.height,0,0,i.width,i.height);e=i}r.bindTexture(r.TEXTURE_2D,this.obj);r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,e);r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE);r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE);if(t){r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR)}else{r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST)}if(k(e.width)&&k(e.height)){if(t){r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR_MIPMAP_LINEAR);r.generateMipmap(r.TEXTURE_2D)}else{r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST_MIPMAP_NEAREST);r.generateMipmap(r.TEXTURE_2D)}}else{if(t){r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR)}else{r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST)}}}function k(e){return e>0&&(e-1&e)===0}function L(e,t,n){this.type=e;this.count=t;this.texture=n}var r=n.gl;n.width=-1;n.height=-1;n.maxTextureSize=r.getParameter(r.MAX_TEXTURE_SIZE);if(!k(n.maxTextureSize))n.maxTextureSize+=1;var i=parseInt(65536/20);var s=parseInt(i/2);var o=1,u=1,a=1;var f=1,l=0;var c=0,h=1;var p=c;var d=null;var v=[],m=[];var g={vdata:new Float32Array(i*4),cdata:new Float32Array(i*4),vcount:0,vpointer:0,cpointer:0,vbuffer:r.createBuffer(),cbuffer:r.createBuffer()};var y={last:new L(-1,0,null),next:0};var b=new Array(s);for(var w=0;w<b.length;w++){b[w]=new L(-1,0,null)}r.clearColor(0,0,0,1);r.clear(r.COLOR_BUFFER_BIT);r.enable(r.BLEND);r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA);gxtkGraphics.prototype.BeginRender=function(){if(this.gc){if(n.width!==this.Width()||n.height!==this.Height()){n.shaderPool=[];n.initShaders();n.width=this.Width();n.height=this.Height();r.viewport(0,0,n.width,n.height)}d=this}};gxtkGraphics.prototype.EndRender=function(){S()};gxtkGraphics.prototype.LoadSurface=function(e){function n(){t.DecLoading();if(!this.texture){var e=v.indexOf(r);if(e!==-1){this.texture=m[e]}else{this.texture=new C(r)}}}var t=this.app;t.IncLoading();var r=loadImage(e,n);if(r)return new gxtkSurface(r,this);t.DecLoading();return null};gxtkGraphics.prototype.SetAlpha=function(e){f=e};gxtkGraphics.prototype.SetColor=function(e,t,n){o=e/255;u=t/255;a=n/255};gxtkGraphics.prototype.SetBlend=function(e){if(l===e)return;S();switch(e){case 1:r.blendFunc(r.SRC_ALPHA,r.ONE);break;default:r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA)}l=e};gxtkGraphics.prototype.SetScissor=function(e,t,n,i){S();if(e!==0||t!==0||n!==this.Width()||i!==this.Height()){r.enable(r.SCISSOR_TEST);t=this.Height()-t-i;r.scissor(e,t,n,i)}else{r.disable(r.SCISSOR_TEST)}};gxtkGraphics.prototype.SetMatrix=function(e,t,n,r,i,s){this.ix=e;this.iy=t;this.jx=n;this.jy=r;this.tx=i;this.ty=s;this.tformed=e!==1||t!==0||n!==0||r!==1||i!==0||s!==0};gxtkGraphics.prototype.Cls=function(e,t,n){r.clearColor(e/255,t/255,n/255,1);r.clear(r.COLOR_BUFFER_BIT)};gxtkGraphics.prototype.DrawPoint=function(e,t){if(p!==c)S();E(r.POINTS,1);if(this.tformed){var n=e;e=n*this.ix+t*this.jx+this.tx;t=n*this.iy+t*this.jy+this.ty}var i=g.vpointer;g.vdata[i]=e;g.vdata[i+1]=t;p=c};gxtkGraphics.prototype.DrawRect=function(e,t,n,r){if(p!==c)S();T(e,t,n,r);p=c};gxtkGraphics.prototype.DrawLine=function(e,t,n,i){if(p!==c)S();E(r.LINES,2);if(this.tformed){var s=e,o=n;e=s*this.ix+t*this.jx+this.tx;t=s*this.iy+t*this.jy+this.ty;n=o*this.ix+i*this.jx+this.tx;i=o*this.iy+i*this.jy+this.ty}var u=g.vpointer;g.vdata[u]=e;g.vdata[u+1]=t;g.vdata[u+2]=0;g.vdata[u+3]=0;g.vdata[u+4]=n;g.vdata[u+5]=i;g.vdata[u+6]=0;g.vdata[u+7]=0;p=c};gxtkGraphics.prototype.DrawOval=function(e,t,n,s){if(p!==c)S();var o=n/2;var u=s/2;var a;if(this.tformed){var f=o*this.ix,l=o*this.iy,h=parseFloat(Math.sqrt(f*f+l*l));var d=u*this.jx,v=u*this.jy,m=parseFloat(Math.sqrt(d*d+v*v));a=parseInt(h+m)}else{a=parseInt(Math.abs(o)+Math.abs(u))}if(a>i){a=i}else if(a<12){a=12}else{a&=~3}e+=o;t+=u;E(r.TRIANGLE_FAN,a);var y=g.vpointer;for(var b=0;b<a;b++){var w=b*6.28318531/a;var x=e+Math.cos(w)*o;var T=t+Math.sin(w)*u;if(this.tformed){var N=x;x=N*this.ix+T*this.jx+this.tx;T=N*this.iy+T*this.jy+this.ty}g.vdata[y]=x;g.vdata[y+1]=T;y+=4}p=c};gxtkGraphics.prototype.DrawPoly=function(e){if(p!==c)S();if(e.length<6||e.length>i*2)return;E(r.TRIANGLE_FAN,e.length/2);var t=g.vpointer;if(this.tformed){for(var n=0;n<e.length;n+=2){g.vdata[t]=e[n]*this.ix+e[n+1]*this.jx+this.tx;g.vdata[t+1]=e[n]*this.iy+e[n+1]*this.jy+this.ty;t+=4}}else{for(var n=0;n<e.length;n+=2){g.vdata[t]=e[n];g.vdata[t+1]=e[n+1];t+=4}}p=c};gxtkGraphics.prototype.DrawSurface=function(e,t,n){if(!e.image.complete)return;if(p!==h)S();if(!e.image.texture){var r=v.indexOf(e.image);if(r!==-1){e.image.texture=m[r]}else{e.image.texture=new C(e.image)}}T(t,n,e.swidth,e.sheight);y.last.texture=e.image.texture.obj;p=h};gxtkGraphics.prototype.DrawSurface2=function(e,t,n,r,i,s,o){if(!e.image.complete)return;if(p!==h)S();if(!e.image.texture){var u=v.indexOf(e.image);if(u!==-1){e.image.texture=m[u]}else{e.image.texture=new C(e.image)}}N(t,n,s,o,r/e.image.texture.width,i/e.image.texture.height,(r+s)/e.image.texture.width,(i+o)/e.image.texture.height);y.last.texture=e.image.texture.obj;p=h};gxtkGraphics.prototype.ReadPixels=function(e,t,n,i,s,o,u){S();var a=new Uint8Array(i*s*4);r.readPixels(t,this.Height()-n-s,i,s,r.RGBA,r.UNSIGNED_BYTE,a);var f=0;for(var l=s-1;l>=0;--l){var c=o+l*u;for(var h=0;h<i;++h){e[c++]=a[f+3]<<24|a[f]<<16|a[f+1]<<8|a[f+2];f+=4}}}}};mojoHtml5Gl()