// Mojo HTML5 GL v1.30 | (c) 2012, 2013 Arthur 'devolonter' Bikmullin | https://github.com/devolonter/mojo-html5-gl/blob/master/LICENSE.md
var mojoHtml5Gl=function(g){document.addEventListener("DOMContentLoaded",function(){f("GameCanvas")},false);var d=this.WebGL2D=function d(h){this.api=g;this.canvas=h;this.gl=g;this.simpleShader=g;this.textureShader=g;this.assetsCache=[];this.maxTextureSize=g;h.gl2d=this;var k=this.gl=h.getContext("webgl",{alpha:false})||h.getContext("experimental-webgl",{alpha:false});if(k===g||k===null){return}try{this.simpleShader=this.loadShaders(false);this.textureShader=this.loadShaders(true)}catch(j){throw j}var i=this.api=new a(this);BBMonkeyGame.Main=function(n){var l=new BBMonkeyGame(n);try{bbInit();bbMain()}catch(p){l.Die(p);return}function m(){this.texture=i.createTexture(this);l.DecLoading();if(l.GetLoading()===0){l.Run()}}var q=META_DATA.split("\n");var s=[];for(var o=q.length-1;o>=0;o--){s=q[o].match(/\[(.*)\];type=image\//i);if(s!==null){monkeyPath=bb_data_FixDataPath(s[1]);l.IncLoading();var r=new Image();r.onload=m;r.meta_width=parseInt(l.GetMetaData(monkeyPath,"width"));r.meta_height=parseInt(l.GetMetaData(monkeyPath,"height"));r.src=l.PathToUrl(monkeyPath);n.gl2d.assetsCache[monkeyPath]=new gxtkSurface(r,this)}}};h.getContext=(function(l){return function(m){return l}}(this.api))};d.prototype.getFragmentShaderSource=function e(h){var i=[];i.push("precision mediump float;","varying vec4 vColor;");if(h){i.push("varying vec2 vTextureCoord;","uniform sampler2D uSampler;")}i.push("void main(void) {");if(h){i.push("gl_FragColor = texture2D(uSampler, vTextureCoord) * vColor;")}else{i.push("gl_FragColor = vColor;")}i.push("}");return i.join("\n")};d.prototype.getVertexShaderSource=function c(k){var j=2/this.canvas.width,l=-2/this.canvas.height;var i=[];i.push("attribute vec4 aVertexPosition;","attribute vec4 aVertexColor;","varying vec4 vColor;","const mat4 pMatrix = mat4("+j+",0,0,0, 0,"+l+",0,0, 0,0,1.0,1.0, -1.0,1.0,0,0);");if(k){i.push("varying vec2 vTextureCoord;")}i.push("void main(void) {","vec3 position = vec3(aVertexPosition.x, aVertexPosition.y, 1.0);","gl_Position = pMatrix * vec4(position, 1.0);","vColor = aVertexColor;");if(k){i.push("vTextureCoord = aVertexPosition.zw;")}i.push("}");return i.join("\n")};d.prototype.loadShaders=function b(i){var j=this.gl;var h=j.createShader(j.FRAGMENT_SHADER);j.shaderSource(h,this.getFragmentShaderSource(i));j.compileShader(h);if(!j.getShaderParameter(h,j.COMPILE_STATUS)){throw"fragment shader error: "+j.getShaderInfoLog(h)}var l=j.createShader(j.VERTEX_SHADER);j.shaderSource(l,this.getVertexShaderSource(i));j.compileShader(l);if(!j.getShaderParameter(l,j.COMPILE_STATUS)){throw"vertex shader error: "+j.getShaderInfoLog(l)}var k=this.shaderProgram=j.createProgram();j.attachShader(k,h);j.attachShader(k,l);j.linkProgram(k);if(!j.getProgramParameter(k,j.LINK_STATUS)){throw"Could not initialise shaders."}k.vertexPositionAttribute=j.getAttribLocation(k,"aVertexPosition");j.enableVertexAttribArray(k.vertexPositionAttribute);k.vertexColorAttribute=j.getAttribLocation(k,"aVertexColor");j.enableVertexAttribArray(k.vertexColorAttribute);k.uColor=j.getUniformLocation(k,"uColor");k.uSampler=j.getUniformLocation(k,"uSampler");return k};var a=this.WebGL2DAPI=function a(E){if(CFG_CONFIG==="debug"){print("WebGL enabled")}var z=E.gl;E.width=-1;E.height=-1;E.maxTextureSize=z.getParameter(z.MAX_TEXTURE_SIZE);if(!m(E.maxTextureSize)){E.maxTextureSize+=1}var p=2048;var G=parseInt(p/2);var n=1,q=1,h=1;var l=1,x=0;var A=0,o=1;var t=A;var B=null;var v=E.simpleShader;var r=E.textureShader;var w={vdata:new Float32Array(p*4),cdata:new Float32Array(p*4),vcount:0,vpointer:0,cpointer:0,vbuffer:z.createBuffer(),cbuffer:z.createBuffer()};var F={last:new j(-1,0,null),next:0};var k=new Array(G);for(var y=0;y<k.length;y++){k[y]=new j(-1,0,null)}z.clearColor(0,0,0,1);z.clear(z.COLOR_BUFFER_BIT);z.enable(z.BLEND);z.blendFunc(z.SRC_ALPHA,z.ONE_MINUS_SRC_ALPHA);gxtkGraphics.prototype.LoadSurface=function(i){return E.assetsCache[i]};gxtkGraphics.prototype.BeginRender=function(){if(this.gc){if(E.width!==this.Width()||E.height!==this.Height()){v=E.simpleShader=E.loadShaders(false);r=E.textureShader=E.loadShaders(true);E.width=this.Width();E.height=this.Height();z.viewport(0,0,E.width,E.height)}B=this}};gxtkGraphics.prototype.EndRender=function(){s()};gxtkGraphics.prototype.CreateSurface=function(J,H){var I=document.createElement("canvas");I.width=J;I.height=H;I.meta_width=J;I.meta_height=H;I.texture=E.api.createTexture(I);I.complete=true;var i=new gxtkSurface(I,this);i.gc=I.getContext("2d");return i};gxtkGraphics.prototype.SetAlpha=function(i){l=i};gxtkGraphics.prototype.SetColor=function(I,H,i){n=I/255;q=H/255;h=i/255};gxtkGraphics.prototype.SetBlend=function(i){if(x===i){return}s();switch(i){case 1:z.blendFunc(z.SRC_ALPHA,z.ONE);break;default:z.blendFunc(z.SRC_ALPHA,z.ONE_MINUS_SRC_ALPHA)}x=i};gxtkGraphics.prototype.SetScissor=function(i,J,H,I){s();if(i!==0||J!==0||H!==this.Width()||I!==this.Height()){z.enable(z.SCISSOR_TEST);J=this.Height()-J-I;z.scissor(i,J,H,I)}else{z.disable(z.SCISSOR_TEST)}};gxtkGraphics.prototype.SetMatrix=function(J,H,L,K,I,i){this.ix=J;this.iy=H;this.jx=L;this.jy=K;this.tx=I;this.ty=i;this.tformed=(J!==1||H!==0||L!==0||K!==1||I!==0||i!==0)};gxtkGraphics.prototype.Cls=function(I,H,i){z.clearColor(I/255,H/255,i/255,1);z.clear(z.COLOR_BUFFER_BIT)};gxtkGraphics.prototype.DrawPoint=function(i,J){if(t!==A){s();t=A}C(z.POINTS,1);if(this.tformed){var H=i;i=H*this.ix+J*this.jx+this.tx;J=H*this.iy+J*this.jy+this.ty}var I=w.vpointer;w.vdata[I]=i;w.vdata[I+1]=J};gxtkGraphics.prototype.DrawRect=function(i,J,H,I){if(t!==A){s();t=A}D(i,J,H,I)};gxtkGraphics.prototype.DrawLine=function(J,L,I,K){if(t!==A){s();t=A}C(z.LINES,2);if(this.tformed){var H=J,i=I;J=H*this.ix+L*this.jx+this.tx;L=H*this.iy+L*this.jy+this.ty;I=i*this.ix+K*this.jx+this.tx;K=i*this.iy+K*this.jy+this.ty}var M=w.vpointer;w.vdata[M]=J;w.vdata[M+1]=L;w.vdata[M+2]=0;w.vdata[M+3]=0;w.vdata[M+4]=I;w.vdata[M+5]=K;w.vdata[M+6]=0;w.vdata[M+7]=0};gxtkGraphics.prototype.DrawOval=function(O,M,P,X){if(t!==A){s();t=A}var N=P/2;var V=X/2;var R;if(this.tformed){var L=N*this.ix,J=N*this.iy,U=parseFloat(Math.sqrt(L*L+J*J));var T=V*this.jx,Q=V*this.jy,H=parseFloat(Math.sqrt(T*T+Q*Q));R=parseInt(U+H)}else{R=parseInt(Math.abs(N)+Math.abs(V))}if(R>p){R=p}else{if(R<12){R=12}else{R&=~3}}O+=N;M+=V;C(z.TRIANGLE_FAN,R);var S=w.vpointer;for(var W=0;W<R;W++){var K=W*6.28318531/R;var Y=(O+Math.cos(K)*N);var I=(M+Math.sin(K)*V);if(this.tformed){var Z=Y;Y=Z*this.ix+I*this.jx+this.tx;I=Z*this.iy+I*this.jy+this.ty}w.vdata[S]=Y;w.vdata[S+1]=I;S+=4}};gxtkGraphics.prototype.DrawPoly=function(J){if(t!==A){s();t=A}if(J.length<6||J.length>p*2){return}C(z.TRIANGLE_FAN,J.length/2);var I=w.vpointer;if(this.tformed){for(var H=0;H<J.length;H+=2){w.vdata[I]=J[H]*this.ix+J[H+1]*this.jx+this.tx;w.vdata[I+1]=J[H]*this.iy+J[H+1]*this.jy+this.ty;I+=4}}else{for(var H=0;H<J.length;H+=2){w.vdata[I]=J[H];w.vdata[I+1]=J[H+1];I+=4}}};gxtkGraphics.prototype.DrawSurface=function(H,i,I){if(!H.image.complete){return}if(t!==o){s();t=o}D(i,I,H.swidth,H.sheight);F.last.texture=H.image.texture};gxtkGraphics.prototype.DrawSurface2=function(H,i,M,J,I,K,L){if(!H.image.complete){return}if(t!==o){s();t=o}D(i,M,K,L,J/H.image.meta_width,I/H.image.meta_height,(J+K)/H.image.meta_width,(I+L)/H.image.meta_height);F.last.texture=H.image.texture};gxtkGraphics.prototype.ReadPixels=function(J,Q,O,I,S,L,H){s();var N=new Uint8Array(I*S*4);z.readPixels(Q,this.Height()-O-S,I,S,z.RGBA,z.UNSIGNED_BYTE,N);var M=0;for(var P=S-1;P>=0;--P){var K=L+P*H;for(var R=0;R<I;++R){J[K++]=(N[M+3]<<24)|(N[M]<<16)|(N[M+1]<<8)|N[M+2];M+=4}}};gxtkGraphics.prototype.WritePixels2=function(L,M,T,R,K,V,P,J){var I=L.gc.createImageData(K,V);var H=I.data,Q=0,O=P,U,S,N;for(S=0;S<V;++S){for(U=0;U<K;++U){N=M[O++];H[Q]=(N>>16)&255;H[Q+1]=(N>>8)&255;H[Q+2]=N&255;H[Q+3]=(N>>24)&255;Q+=4}O+=J-K}L.gc.putImageData(I,T,R);z.deleteTexture(L.image.texture);L.image.texture=E.api.createTexture(L.image)};function C(I,J){if(w.vcount+J>p||F.next===G){s()}F.last=k[F.next];F.next+=1;F.last.type=I;F.last.count=J;F.last.texture=null;w.vpointer=w.vcount*4;w.cpointer=w.vcount*4;w.vcount+=J;var K=w.cpointer;for(var H=0;H<J;H++){w.cdata[K]=n;w.cdata[K+1]=q;w.cdata[K+2]=h;w.cdata[K+3]=l;K+=4}}function s(){if(w.vcount===0){return}var K=null;var H=0;var J;switch(t){case A:z.useProgram(v);z.bindBuffer(z.ARRAY_BUFFER,w.vbuffer);z.bufferData(z.ARRAY_BUFFER,w.vdata,z.DYNAMIC_DRAW);z.vertexAttribPointer(v.vertexPositionAttribute,4,z.FLOAT,false,0,0);z.bindBuffer(z.ARRAY_BUFFER,w.cbuffer);z.bufferData(z.ARRAY_BUFFER,w.cdata,z.DYNAMIC_DRAW);z.vertexAttribPointer(v.vertexColorAttribute,4,z.FLOAT,false,0,0);for(var I=0;I<F.next;I++){J=k[I];z.drawArrays(J.type,H,J.count);H+=J.count}break;case o:z.useProgram(r);z.bindBuffer(z.ARRAY_BUFFER,w.vbuffer);z.bufferData(z.ARRAY_BUFFER,w.vdata,z.DYNAMIC_DRAW);z.vertexAttribPointer(r.vertexPositionAttribute,4,z.FLOAT,false,0,0);z.bindBuffer(z.ARRAY_BUFFER,w.cbuffer);z.bufferData(z.ARRAY_BUFFER,w.cdata,z.DYNAMIC_DRAW);z.vertexAttribPointer(r.vertexColorAttribute,4,z.FLOAT,false,0,0);for(var I=0;I<F.next;I++){J=k[I];if(K!==J.texture){z.bindTexture(z.TEXTURE_2D,J.texture);z.activeTexture(z.TEXTURE0);z.uniform1i(r.uSampler,0);K=J.texture}z.drawArrays(J.type,H,J.count);H+=J.count}break}u()}function u(){w.vcount=0;F.next=0}function D(N,M,O,R,U,J,S,H){C(z.TRIANGLE_FAN,4);var W=N,V=N+O,T=N+O,Q=N;var L=M,K=M,I=M+R,i=M+R;if(B.tformed){var aa=W,Z=V,Y=T,X=Q;W=aa*B.ix+L*B.jx+B.tx;L=aa*B.iy+L*B.jy+B.ty;V=Z*B.ix+K*B.jx+B.tx;K=Z*B.iy+K*B.jy+B.ty;T=Y*B.ix+I*B.jx+B.tx;I=Y*B.iy+I*B.jy+B.ty;Q=X*B.ix+i*B.jx+B.tx;i=X*B.iy+i*B.jy+B.ty}var P=w.vpointer;if(U===g){w.vdata[P]=W;w.vdata[P+1]=L;w.vdata[P+2]=0;w.vdata[P+3]=0;w.vdata[P+4]=V;w.vdata[P+5]=K;w.vdata[P+6]=1;w.vdata[P+7]=0;w.vdata[P+8]=T;w.vdata[P+9]=I;w.vdata[P+10]=1;w.vdata[P+11]=1;w.vdata[P+12]=Q;w.vdata[P+13]=i;w.vdata[P+14]=0;w.vdata[P+15]=1}else{w.vdata[P]=W;w.vdata[P+1]=L;w.vdata[P+2]=U;w.vdata[P+3]=J;w.vdata[P+4]=V;w.vdata[P+5]=K;w.vdata[P+6]=S;w.vdata[P+7]=J;w.vdata[P+8]=T;w.vdata[P+9]=I;w.vdata[P+10]=S;w.vdata[P+11]=H;w.vdata[P+12]=Q;w.vdata[P+13]=i;w.vdata[P+14]=U;w.vdata[P+15]=H}}a.prototype.createTexture=function(J){var I=z.createTexture();var K=(typeof(CFG_MOJO_IMAGE_FILTERING_ENABLED)==="undefined"||CFG_MOJO_IMAGE_FILTERING_ENABLED==="true"||CFG_MOJO_IMAGE_FILTERING_ENABLED==="1");if(J.width>E.maxTextureSize||J.height>E.maxTextureSize){var H=document.createElement("canvas");H.width=(J.width>E.maxTextureSize)?E.maxTextureSize:J.width;H.height=(J.height>E.maxTextureSize)?E.maxTextureSize:J.height;var i=H.getContext("2d");i.drawImage(J,0,0,J.width,J.height,0,0,H.width,H.height);J=H}z.bindTexture(z.TEXTURE_2D,I);z.texImage2D(z.TEXTURE_2D,0,z.RGBA,z.RGBA,z.UNSIGNED_BYTE,J);z.texParameteri(z.TEXTURE_2D,z.TEXTURE_WRAP_S,z.CLAMP_TO_EDGE);z.texParameteri(z.TEXTURE_2D,z.TEXTURE_WRAP_T,z.CLAMP_TO_EDGE);if(K){z.texParameteri(z.TEXTURE_2D,z.TEXTURE_MAG_FILTER,z.LINEAR)}else{z.texParameteri(z.TEXTURE_2D,z.TEXTURE_MAG_FILTER,z.NEAREST)}if(m(J.width)&&m(J.height)){if(K){z.texParameteri(z.TEXTURE_2D,z.TEXTURE_MIN_FILTER,z.LINEAR_MIPMAP_LINEAR);z.generateMipmap(z.TEXTURE_2D)}else{z.texParameteri(z.TEXTURE_2D,z.TEXTURE_MIN_FILTER,z.NEAREST_MIPMAP_NEAREST);z.generateMipmap(z.TEXTURE_2D)}}else{if(K){z.texParameteri(z.TEXTURE_2D,z.TEXTURE_MIN_FILTER,z.LINEAR)}else{z.texParameteri(z.TEXTURE_2D,z.TEXTURE_MIN_FILTER,z.NEAREST)}}return I};function m(i){return i>0&&((i-1)&i)===0}function j(i,I,H){this.type=i;this.count=I;this.texture=H}};function f(i){if(window.WebGLRenderingContext!==g){try{new d(document.getElementById(i))}catch(h){}}}};mojoHtml5Gl();