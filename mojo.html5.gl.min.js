(function(){function g(a){var b=false;if(typeof window.ActiveXObject!="undefined")try{var c=new ActiveXObject("ChromeTab.ChromeFrame");if(c){try{var e=document.createElement("canvas");var f=e.getContext("webgl")||e.getContext("experimental-webgl");b=typeof f!=="undefined"&&f!==null}catch(g){}}}catch(g){}if(navigator.userAgent.indexOf("MSIE")<0||b){if(!b&&navigator.userAgent.indexOf("Opera")>=0)try{new d(document.createElement("canvas"))}catch(g){return}new d(document.getElementById(a))}else{var h=document.createElement("object");h.onreadystatechange=function(){try{var b=h.getContext("webgl");b.readPixels(0,0,e.width,e.height,b.RGBA,b.UNSIGNED_BYTE,new Uint8Array(e.width*e.height*4))}catch(c){return}var e=document.getElementById(a);var f=document.createElement("object");f.onreadystatechange=function(){new d(f)};e.parentNode.replaceChild(f,e);f.id=a;f.width=e.width;f.height=e.height;f.type="application/x-webgl"};h.type="application/x-webgl"}}document.addEventListener("DOMContentLoaded",function(){g("GameCanvas")},false);var a=3.141592653589793;var b=2*a;var c=a/2;var d=this.WebGL2D=function(b){this.canvas=b;this.gl=undefined;this.fs=undefined;this.vs=undefined;this.shaderProgram=undefined;this.shaderPool=[];this.maxTextureSize=undefined;this.width;this.height;b.gl2d=this;var c=this.gl=b.getContext("webgl",{alpha:false})||b.getContext("experimental-webgl",{alpha:false});if(typeof c==="undefined"||c===null)return;try{this.initShaders()}catch(d){throw d}b.getContext=function(a){return function(b){return new f(a)}}(this)};var e={texture:1,crop:2};d.prototype.getFragmentShaderSource=function(b){var c=[];c.push("precision mediump float;","varying vec4 vColor;");if(b&e.texture){c.push("varying vec2 vTextureCoord;","uniform sampler2D uSampler;");if(b&e.crop){c.push("uniform vec4 uCropSource;")}}c.push("void main(void) {");if(b&e.texture){if(b&e.crop){c.push("gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.x * uCropSource.z, vTextureCoord.y * uCropSource.w) + uCropSource.xy) * vColor;")}else{c.push("gl_FragColor = texture2D(uSampler, vTextureCoord) * vColor;")}}else{c.push("gl_FragColor = vColor;")}c.push("}");return c.join("\n")};d.prototype.getVertexShaderSource=function(b){var c=2/this.canvas.width,d=-2/this.canvas.height;var f=[];f.push("attribute vec4 aVertexPosition;","uniform vec4 uColor;","varying vec4 vColor;","const mat4 pMatrix = mat4("+c+",0,0,0, 0,"+d+",0,0, 0,0,1.0,1.0, -1.0,1.0,0,0);");if(b&e.texture){f.push("varying vec2 vTextureCoord;")}f.push("void main(void) {","vec3 position = vec3(aVertexPosition.x, aVertexPosition.y, 1.0);","gl_Position = pMatrix * vec4(position, 1.0);","vColor = uColor;");if(b&e.texture){f.push("vTextureCoord = aVertexPosition.zw;")}f.push("}");return f.join("\n")};d.prototype.initShaders=function(b){var c=this.gl;b=b||0;var d=this.shaderPool;if(!d){d=this.shaderPool=[]}d=d[b];if(d){c.useProgram(d);this.shaderProgram=d;return d}else{var e=this.fs=c.createShader(c.FRAGMENT_SHADER);c.shaderSource(this.fs,this.getFragmentShaderSource(b));c.compileShader(this.fs);if(!c.getShaderParameter(this.fs,c.COMPILE_STATUS)){throw"fragment shader error: "+c.getShaderInfoLog(this.fs)}var f=this.vs=c.createShader(c.VERTEX_SHADER);c.shaderSource(this.vs,this.getVertexShaderSource(b));c.compileShader(this.vs);if(!c.getShaderParameter(this.vs,c.COMPILE_STATUS)){throw"vertex shader error: "+c.getShaderInfoLog(this.vs)}var g=this.shaderProgram=c.createProgram();c.attachShader(g,e);c.attachShader(g,f);c.linkProgram(g);if(!c.getProgramParameter(g,c.LINK_STATUS)){throw"Could not initialise shaders."}c.useProgram(g);g.vertexPositionAttribute=c.getAttribLocation(g,"aVertexPosition");c.enableVertexAttribArray(g.vertexPositionAttribute);g.uColor=c.getUniformLocation(g,"uColor");g.uSampler=c.getUniformLocation(g,"uSampler");g.uCropSource=c.getUniformLocation(g,"uCropSource");this.shaderPool[b]=g;return g}};var f=this.WebGL2DAPI=function(b){function w(a,b){if(s.vcount+b>d||t.next===f){x()}t.last=u[t.next];t.next+=1;t.last.type=a;t.last.count=b;t.last.texture=null;s.vpointer=s.vcount*4;s.vcount+=b}function x(){if(s.vcount===0)return;var a=b.shaderProgram;var d=null;var f=0;var k;c.bufferData(c.ARRAY_BUFFER,s.vdata,c.DYNAMIC_DRAW);switch(o){case l:a=b.initShaders(0);c.vertexAttribPointer(a.vertexPositionAttribute,4,c.FLOAT,false,0,0);c.uniform4f(a.uColor,g/255,h/255,i/255,j);for(var p=0;p<t.next;p++){k=u[p];c.drawArrays(k.type,f,k.count);f+=k.count}break;case m:a=b.initShaders(e.texture);c.vertexAttribPointer(a.vertexPositionAttribute,4,c.FLOAT,false,0,0);c.uniform4f(a.uColor,g/255,h/255,i/255,j);for(var p=0;p<t.next;p++){k=u[p];if(d!==k.texture){c.bindTexture(c.TEXTURE_2D,k.texture.obj);c.activeTexture(c.TEXTURE0);c.uniform1i(a.uSampler,0);d=k.texture}c.drawArrays(k.type,f,k.count);f+=k.count}break;case n:a=b.initShaders(e.texture|e.crop);c.vertexAttribPointer(a.vertexPositionAttribute,4,c.FLOAT,false,0,0);c.uniform4f(a.uColor,g/255,h/255,i/255,j);for(var p=0;p<t.next;p++){k=u[p];if(d!==k.texture){c.bindTexture(c.TEXTURE_2D,k.texture.obj);c.activeTexture(c.TEXTURE0);c.uniform1i(a.uSampler,0);d=k.texture}c.uniform4f(a.uCropSource,k.srcx/k.texture.width,k.srcy/k.texture.height,k.srcw/k.texture.width,k.srch/k.texture.height);c.drawArrays(k.type,f,k.count);f+=k.count}break}y()}function y(){s.vcount=0;t.next=0;o=l}function z(a,b,d,e){w(c.TRIANGLE_FAN,4);var f=a,g=a+d,h=a+d,i=a;var j=b,k=b,l=b+e,m=b+e;if(p.tformed){var n=f,o=g,q=h,r=i;f=n*p.ix+j*p.jx+p.tx;j=n*p.iy+j*p.jy+p.ty;g=o*p.ix+k*p.jx+p.tx;k=o*p.iy+k*p.jy+p.ty;h=q*p.ix+l*p.jx+p.tx;l=q*p.iy+l*p.jy+p.ty;i=r*p.ix+m*p.jx+p.tx;m=r*p.iy+m*p.jy+p.ty}s.vdata[s.vpointer]=f;s.vdata[s.vpointer+1]=j;s.vdata[s.vpointer+2]=0;s.vdata[s.vpointer+3]=0;s.vdata[s.vpointer+4]=g;s.vdata[s.vpointer+5]=k;s.vdata[s.vpointer+6]=1;s.vdata[s.vpointer+7]=0;s.vdata[s.vpointer+8]=h;s.vdata[s.vpointer+9]=l;s.vdata[s.vpointer+10]=1;s.vdata[s.vpointer+11]=1;s.vdata[s.vpointer+12]=i;s.vdata[s.vpointer+13]=m;s.vdata[s.vpointer+14]=0;s.vdata[s.vpointer+15]=1}function A(a){this.obj=c.createTexture();this.index=r.push(this);q.push(a);this.width=a.meta_width;this.height=a.meta_height;var d=typeof CFG_MOJO_IMAGE_FILTERING_ENABLED==="undefined"||CFG_MOJO_IMAGE_FILTERING_ENABLED==="true"||CFG_MOJO_IMAGE_FILTERING_ENABLED==="1";if(a.width>b.maxTextureSize||a.height>b.maxTextureSize){var e=document.createElement("canvas");e.width=a.width>b.maxTextureSize?b.maxTextureSize:a.width;e.height=a.height>b.maxTextureSize?b.maxTextureSize:a.height;var f=e.getContext("2d");f.drawImage(a,0,0,a.width,a.height,0,0,e.width,e.height);a=e}c.bindTexture(c.TEXTURE_2D,this.obj);c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,a);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE);if(d){c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.LINEAR)}else{c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.NEAREST)}if(B(a.width)&&B(a.height)){if(d){c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR_MIPMAP_LINEAR);c.generateMipmap(c.TEXTURE_2D)}else{c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.NEAREST_MIPMAP_NEAREST);c.generateMipmap(c.TEXTURE_2D)}}else{if(d){c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR)}else{c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.NEAREST)}}}function B(a){return a>0&&(a-1&a)===0}var c=b.gl;b.width=-1;b.height=-1;b.maxTextureSize=c.getParameter(c.MAX_TEXTURE_SIZE);if(!B(b.maxTextureSize))b.maxTextureSize+=1;var d=parseInt(65536/20);var f=parseInt(d/2);var g=1,h=1,i=1;var j=1,k=0;var l=0,m=1,n=2;var o=l;var p;var q=[],r=[];var s={vdata:new Float32Array(d*4),vcount:0,vpointer:0,pointer:c.createBuffer()};var t={last:{type:-1,count:0},next:0};var u=new Array(f);for(var v=0;v<u.length;v++){u[v]={type:-1,count:0,texture:null,srcx:0,srcy:0,srcw:0,srch:0}}c.clearColor(0,0,0,1);c.clear(c.COLOR_BUFFER_BIT);c.enable(c.BLEND);c.blendFunc(c.SRC_ALPHA,c.ONE_MINUS_SRC_ALPHA);c.bindBuffer(c.ARRAY_BUFFER,s.pointer);gxtkGraphics.prototype.BeginRender=function(){if(this.gc){if(b.width!==this.Width()||b.height!==this.Height()){b.shaderPool=[];b.initShaders();b.width=this.Width();b.height=this.Height();c.viewport(0,0,b.width,b.height)}p=this}};gxtkGraphics.prototype.EndRender=function(){x()};gxtkGraphics.prototype.LoadSurface=function(a){function c(){b.DecLoading();if(!this.texture){var a=q.indexOf(d);if(a!==-1){this.texture=r[a]}else{this.texture=new A(d)}}}var b=this.app;b.IncLoading();var d=loadImage(a,c);if(d)return new gxtkSurface(d,this);b.DecLoading();return null};gxtkGraphics.prototype.SetAlpha=function(a){if(j===a)return;x();j=a};gxtkGraphics.prototype.SetColor=function(a,b,c){if(g===a&&h===b&&i===c)return;x();g=a;h=b;i=c};gxtkGraphics.prototype.SetBlend=function(a){if(k===a)return;x();switch(a){case 1:c.blendFunc(c.SRC_ALPHA,c.ONE);break;default:c.blendFunc(c.SRC_ALPHA,c.ONE_MINUS_SRC_ALPHA)}k=a};gxtkGraphics.prototype.SetScissor=function(a,b,d,e){x();if(a!==0||b!==0||d!==this.Width()||e!==this.Height()){c.enable(c.SCISSOR_TEST);b=this.Height()-b-e;c.scissor(a,b,d,e)}else{c.disable(c.SCISSOR_TEST)}};gxtkGraphics.prototype.SetMatrix=function(a,b,c,d,e,f){this.ix=a;this.iy=b;this.jx=c;this.jy=d;this.tx=e;this.ty=f;this.tformed=a!==1||b!==0||c!==0||d!==1||e!==0||f!==0};gxtkGraphics.prototype.Cls=function(a,b,d){c.clearColor(a/255,b/255,d/255,1);c.clear(c.COLOR_BUFFER_BIT)};gxtkGraphics.prototype.DrawPoint=function(a,b){if(o!==l)x();w(c.POINTS,1);if(this.tformed){var d=a;a=d*this.ix+b*this.jx+this.tx;b=d*this.iy+b*this.jy+this.ty}s.vdata[s.vpointer]=a;s.vdata[s.vpointer+1]=b;o=l};gxtkGraphics.prototype.DrawRect=function(a,b,c,d){if(o!==l)x();z(a,b,c,d);o=l};gxtkGraphics.prototype.DrawLine=function(a,b,d,e){if(o!==l)x();w(c.LINES,2);if(this.tformed){var f=x0,g=a;a=f*this.ix+b*this.jx+this.tx;b=f*this.iy+b*this.jy+this.ty;d=g*this.ix+e*this.jx+this.tx;e=g*this.iy+e*this.jy+this.ty}s.vdata[s.vpointer]=a;s.vdata[s.vpointer+1]=b;s.vdata[s.vpointer+2]=0;s.vdata[s.vpointer+3]=0;s.vdata[s.vpointer+4]=d;s.vdata[s.vpointer+5]=e;s.vdata[s.vpointer+6]=0;s.vdata[s.vpointer+7]=0;o=l};gxtkGraphics.prototype.DrawOval=function(a,b,e,f){if(o!==l)x();var g=e/2;var h=f/2;var i;if(this.tformed){var j=g*this.ix,k=g*this.iy,m=parseFloat(Math.sqrt(j*j+k*k));var n=h*this.jx,p=h*this.jy,q=parseFloat(Math.sqrt(n*n+p*p));i=parseInt(m+q)}else{i=parseInt(Math.abs(g)+Math.abs(h))}if(i>d){i=d}else if(i<12){i=12}else{i&=~3}a+=g;b+=h;w(c.TRIANGLE_FAN,i);for(var r=0;r<i;r++){var t=r*6.28318531/i;var u=a+Math.cos(t)*g;var v=b+Math.sin(t)*h;if(this.tformed){var y=u;u=y*this.ix+v*jx+this.tx;v=y*this.iy+v*jy+this.ty}s.vdata[s.vpointer]=u;s.vdata[s.vpointer+1]=v;s.vpointer+=4}o=l};gxtkGraphics.prototype.DrawPoly=function(a){if(o!==l)x();if(a.length<6||a.length>d*2)return;w(c.TRIANGLE_FAN,a.length/2);if(this.tformed){for(var b=0;b<a.length;b+=2){s.vdata[s.vpointer]=a[b]*this.ix+a[b+1]*this.jx+this.tx;s.vdata[s.vpointer+1]=a[b]*this.iy+a[b+1]*this.jy+this.ty;s.vpointer+=4}}else{for(var b=0;b<a.length;b+=2){s.vdata[s.vpointer]=a[b];s.vdata[s.vpointer+1]=a[b+1];s.vpointer+=4}}o=l};gxtkGraphics.prototype.DrawSurface=function(a,b,c){if(!a.image.complete)return;if(o!==m)x();if(!a.image.texture){var d=q.indexOf(a.image);if(d!==-1){a.image.texture=r[d]}else{a.image.texture=new A(a.image)}}z(b,c,a.swidth,a.sheight);t.last.texture=a.image.texture;o=m};gxtkGraphics.prototype.DrawSurface2=function(a,b,c,d,e,f,g){if(!a.image.complete)return;if(o!==n)x();if(!a.image.texture){var h=q.indexOf(a.image);if(h!==-1){a.image.texture=r[h]}else{a.image.texture=new A(a.image)}}z(b,c,f,g);t.last.srcx=d;t.last.srcy=e;t.last.srcw=f;t.last.srch=g;t.last.texture=a.image.texture;o=n};gxtkGraphics.prototype.ReadPixels=function(a,b,d,e,f,g,h){x();var i=new Uint8Array(e*f*4);c.readPixels(b,this.Height()-d-f,e,f,c.RGBA,c.UNSIGNED_BYTE,i);var j=0;for(var k=f-1;k>=0;--k){var l=g+k*h;for(var m=0;m<e;++m){a[l++]=i[j+3]<<24|i[j]<<16|i[j+1]<<8|i[j+2];j+=4}}return 0}}})()