// Mojo HTML5 GL v1.32b | (c) 2012, 2013 Arthur 'devolonter' Bikmullin | https://github.com/devolonter/mojo-html5-gl/blob/master/LICENSE.md
var mojoHtml5Gl=function(g){document.addEventListener("DOMContentLoaded",function(){f("GameCanvas")},false);var d=function d(h){this.api=g;this.canvas=h;this.gl=g;this.width=h.width;this.height=h.height;this.simpleShader=g;this.textureShader=g;this.maxTextureSize=g;h.gl2d=this;var j=this.gl=h.getContext("webgl",{alpha:false})||h.getContext("experimental-webgl",{alpha:false});if(j===g||j===null){return}try{this.simpleShader=this.loadShaders(false);this.textureShader=this.loadShaders(true)}catch(i){throw i}this.api=new a(this);h.getContext=(function(k){return function(l){return k}}(this.api))};d.prototype.getFragmentShaderSource=function e(h){var i=[];i.push("precision mediump float;","varying vec4 vColor;");if(h){i.push("varying vec2 vTextureCoord;","uniform sampler2D uSampler;")}i.push("void main(void) {");if(h){i.push("gl_FragColor = texture2D(uSampler, vTextureCoord) * vColor;")}else{i.push("gl_FragColor = vColor;")}i.push("}");return i.join("\n")};d.prototype.getVertexShaderSource=function c(k){var j=2/this.canvas.width,l=-2/this.canvas.height;var i=[];i.push("attribute vec4 aVertexPosition;","attribute vec4 aVertexColor;","varying vec4 vColor;","const mat4 pMatrix = mat4("+j+",0,0,0, 0,"+l+",0,0, 0,0,1.0,1.0, -1.0,1.0,0,0);");if(k){i.push("varying vec2 vTextureCoord;")}i.push("void main(void) {","vec3 position = vec3(aVertexPosition.x, aVertexPosition.y, 1.0);","gl_Position = pMatrix * vec4(position, 1.0);","vColor = aVertexColor;");if(k){i.push("vTextureCoord = aVertexPosition.zw;")}i.push("}");return i.join("\n")};d.prototype.loadShaders=function b(i){var j=this.gl;var h=j.createShader(j.FRAGMENT_SHADER);j.shaderSource(h,this.getFragmentShaderSource(i));j.compileShader(h);if(!j.getShaderParameter(h,j.COMPILE_STATUS)){throw"fragment shader error: "+j.getShaderInfoLog(h)}var l=j.createShader(j.VERTEX_SHADER);j.shaderSource(l,this.getVertexShaderSource(i));j.compileShader(l);if(!j.getShaderParameter(l,j.COMPILE_STATUS)){throw"vertex shader error: "+j.getShaderInfoLog(l)}var k=this.shaderProgram=j.createProgram();j.attachShader(k,h);j.attachShader(k,l);j.linkProgram(k);if(!j.getProgramParameter(k,j.LINK_STATUS)){throw"Could not initialise shaders."}k.vertexPositionAttribute=j.getAttribLocation(k,"aVertexPosition");j.enableVertexAttribArray(k.vertexPositionAttribute);k.vertexColorAttribute=j.getAttribLocation(k,"aVertexColor");j.enableVertexAttribArray(k.vertexColorAttribute);k.uColor=j.getUniformLocation(k,"uColor");k.uSampler=j.getUniformLocation(k,"uSampler");return k};var a=function a(F){if(CFG_CONFIG==="debug"){print("WebGL enabled")}var A=F.gl;F.width=-1;F.height=-1;F.maxTextureSize=A.getParameter(A.MAX_TEXTURE_SIZE);if(!m(F.maxTextureSize)){F.maxTextureSize+=1}var q=2048;var H=(q/2)|0;var o=1,r=1,h=1;var l=1,y=0;var B=0,p=1;var u=B;var C=null;var w=F.simpleShader;var s=F.textureShader;var x={vdata:new Float32Array(q*4),cdata:new Float32Array(q*4),vcount:0,vpointer:0,cpointer:0,vbuffer:A.createBuffer(),cbuffer:A.createBuffer()};var G={last:new j(-1,0,null),next:0};var k=new Array(H);for(var z=0;z<k.length;z++){k[z]=new j(-1,0,null)}A.clearColor(0,0,0,1);A.clear(A.COLOR_BUFFER_BIT);A.enable(A.BLEND);A.blendFunc(A.SRC_ALPHA,A.ONE_MINUS_SRC_ALPHA);gxtkGraphics.prototype.LoadSurface=function(K){var I=this.game;var i=I.GetMetaData(K,"type");if(i.indexOf("image/")!=0){return null}I.IncLoading();var J=new Image();J.onload=function(){n(this);I.DecLoading()};J.meta_width=parseInt(I.GetMetaData(K,"width"));J.meta_height=parseInt(I.GetMetaData(K,"height"));J.src=I.PathToUrl(K);return new gxtkSurface(J,this)};gxtkSurface.prototype.Discard=function(){if(this.image){A.deleteTexture(this.image.texture);this.image=null}};gxtkGraphics.prototype.CreateSurface=function(K,I){var J=document.createElement("canvas");J.width=K;J.height=I;J.meta_width=K;J.meta_height=I;J.texture=n(J);J.complete=true;var i=new gxtkSurface(J,this);i.gc=J.getContext("2d");return i};gxtkGraphics.prototype.BeginRender=function(){if(!this.gc){return 0}if(this.game.GetLoading()){return 2}if(F.width!==F.canvas.width||F.height!==F.canvas.height){w=F.simpleShader=F.loadShaders(false);s=F.textureShader=F.loadShaders(true);this.width=F.width=F.canvas.width;this.height=F.height=F.canvas.height;A.viewport(0,0,this.width,this.height)}C=this;return 1};gxtkGraphics.prototype.EndRender=function(){t()};gxtkGraphics.prototype.SetAlpha=function(i){l=i};gxtkGraphics.prototype.SetColor=function(J,I,i){o=J/255;r=I/255;h=i/255};gxtkGraphics.prototype.SetBlend=function(i){if(y===i){return}t();switch(i){case 1:A.blendFunc(A.SRC_ALPHA,A.ONE);break;default:A.blendFunc(A.SRC_ALPHA,A.ONE_MINUS_SRC_ALPHA)}y=i};gxtkGraphics.prototype.SetScissor=function(i,K,I,J){t();if(i!==0||K!==0||I!==this.width||J!==this.height){A.enable(A.SCISSOR_TEST);K=this.height-K-J;A.scissor(i,K,I,J)}else{A.disable(A.SCISSOR_TEST)}};gxtkGraphics.prototype.SetMatrix=function(K,I,M,L,J,i){this.ix=K;this.iy=I;this.jx=M;this.jy=L;this.tx=J;this.ty=i;this.tformed=(K!==1||I!==0||M!==0||L!==1||J!==0||i!==0)};gxtkGraphics.prototype.Cls=function(J,I,i){A.clearColor(J/255,I/255,i/255,1);A.clear(A.COLOR_BUFFER_BIT)};gxtkGraphics.prototype.DrawPoint=function(i,K){if(u!==B){t();u=B}D(A.POINTS,1);if(this.tformed){var I=i;i=I*this.ix+K*this.jx+this.tx;K=I*this.iy+K*this.jy+this.ty}var J=x.vpointer;x.vdata[J]=i;x.vdata[J+1]=K};gxtkGraphics.prototype.DrawRect=function(i,K,I,J){if(u!==B){t();u=B}E(i,K,I,J)};gxtkGraphics.prototype.DrawLine=function(K,M,J,L){if(u!==B){t();u=B}D(A.LINES,2);if(this.tformed){var I=K,i=J;K=I*this.ix+M*this.jx+this.tx;M=I*this.iy+M*this.jy+this.ty;J=i*this.ix+L*this.jx+this.tx;L=i*this.iy+L*this.jy+this.ty}var N=x.vpointer;x.vdata[N]=K;x.vdata[N+1]=M;x.vdata[N+2]=0;x.vdata[N+3]=0;x.vdata[N+4]=J;x.vdata[N+5]=L;x.vdata[N+6]=0;x.vdata[N+7]=0};gxtkGraphics.prototype.DrawOval=function(P,N,Q,Y){if(u!==B){t();u=B}var O=Q/2;var W=Y/2;var S;if(this.tformed){var M=O*this.ix,K=O*this.iy,V=Math.sqrt(M*M+K*K);var U=W*this.jx,R=W*this.jy,I=Math.sqrt(U*U+R*R);S=(V+I)|0}else{S=(Math.abs(O)+Math.abs(W))|0}if(S>q){S=q}else{if(S<12){S=12}else{S&=~3}}P+=O;N+=W;D(A.TRIANGLE_FAN,S);var T=x.vpointer;for(var X=0;X<S;X++){var L=X*6.28318531/S;var Z=(P+Math.cos(L)*O);var J=(N+Math.sin(L)*W);if(this.tformed){var aa=Z;Z=aa*this.ix+J*this.jx+this.tx;J=aa*this.iy+J*this.jy+this.ty}x.vdata[T]=Z;x.vdata[T+1]=J;T+=4}};gxtkGraphics.prototype.DrawPoly=function(K){if(u!==B){t();u=B}if(K.length<6||K.length>q*2){return}D(A.TRIANGLE_FAN,K.length/2);var J=x.vpointer;if(this.tformed){for(var I=0;I<K.length;I+=2){x.vdata[J]=K[I]*this.ix+K[I+1]*this.jx+this.tx;x.vdata[J+1]=K[I]*this.iy+K[I+1]*this.jy+this.ty;J+=4}}else{for(var I=0;I<K.length;I+=2){x.vdata[J]=K[I];x.vdata[J+1]=K[I+1];J+=4}}};gxtkGraphics.prototype.DrawSurface=function(I,i,J){if(!I.image.complete){return}if(u!==p){t();u=p}E(i,J,I.swidth,I.sheight);G.last.texture=I.image.texture};gxtkGraphics.prototype.DrawSurface2=function(I,i,N,K,J,L,M){if(!I.image.complete){return}if(u!==p){t();u=p}E(i,N,L,M,K/I.image.meta_width,J/I.image.meta_height,(K+L)/I.image.meta_width,(J+M)/I.image.meta_height);G.last.texture=I.image.texture};gxtkGraphics.prototype.ReadPixels=function(K,R,P,J,T,M,I){t();var O=new Uint8Array(J*T*4);A.readPixels(R,this.height-P-T,J,T,A.RGBA,A.UNSIGNED_BYTE,O);var N=0;for(var Q=T-1;Q>=0;--Q){var L=M+Q*I;for(var S=0;S<J;++S){K[L++]=(O[N+3]<<24)|(O[N]<<16)|(O[N+1]<<8)|O[N+2];N+=4}}};gxtkGraphics.prototype.WritePixels2=function(M,N,U,S,L,W,Q,K){var J=M.gc.createImageData(L,W);var I=J.data,R=0,P=Q,V,T,O;for(T=0;T<W;++T){for(V=0;V<L;++V){O=N[P++];I[R]=(O>>16)&255;I[R+1]=(O>>8)&255;I[R+2]=O&255;I[R+3]=(O>>24)&255;R+=4}P+=K-L}M.gc.putImageData(J,U,S);A.deleteTexture(M.image.texture);n(M.image)};function D(J,K){if(x.vcount+K>q||G.next===H){t()}G.last=k[G.next];G.next+=1;G.last.type=J;G.last.count=K;G.last.texture=null;x.vpointer=x.vcount*4;x.cpointer=x.vcount*4;x.vcount+=K;var L=x.cpointer;for(var I=0;I<K;I++){x.cdata[L]=o;x.cdata[L+1]=r;x.cdata[L+2]=h;x.cdata[L+3]=l;L+=4}}function t(){if(x.vcount===0){return}var L=null;var I=0;var K;switch(u){case B:A.useProgram(w);A.bindBuffer(A.ARRAY_BUFFER,x.vbuffer);A.bufferData(A.ARRAY_BUFFER,x.vdata,A.DYNAMIC_DRAW);A.vertexAttribPointer(w.vertexPositionAttribute,4,A.FLOAT,false,0,0);A.bindBuffer(A.ARRAY_BUFFER,x.cbuffer);A.bufferData(A.ARRAY_BUFFER,x.cdata,A.DYNAMIC_DRAW);A.vertexAttribPointer(w.vertexColorAttribute,4,A.FLOAT,false,0,0);for(var J=0;J<G.next;J++){K=k[J];A.drawArrays(K.type,I,K.count);I+=K.count}break;case p:A.useProgram(s);A.bindBuffer(A.ARRAY_BUFFER,x.vbuffer);A.bufferData(A.ARRAY_BUFFER,x.vdata,A.DYNAMIC_DRAW);A.vertexAttribPointer(s.vertexPositionAttribute,4,A.FLOAT,false,0,0);A.bindBuffer(A.ARRAY_BUFFER,x.cbuffer);A.bufferData(A.ARRAY_BUFFER,x.cdata,A.DYNAMIC_DRAW);A.vertexAttribPointer(s.vertexColorAttribute,4,A.FLOAT,false,0,0);for(var J=0;J<G.next;J++){K=k[J];if(L!==K.texture){A.bindTexture(A.TEXTURE_2D,K.texture);A.activeTexture(A.TEXTURE0);A.uniform1i(s.uSampler,0);L=K.texture}A.drawArrays(K.type,I,K.count);I+=K.count}break}v()}function v(){x.vcount=0;G.next=0}function E(O,N,P,S,V,K,T,I){D(A.TRIANGLE_FAN,4);var X=O,W=O+P,U=O+P,R=O;var M=N,L=N,J=N+S,i=N+S;if(C.tformed){var ab=X,aa=W,Z=U,Y=R;X=ab*C.ix+M*C.jx+C.tx;M=ab*C.iy+M*C.jy+C.ty;W=aa*C.ix+L*C.jx+C.tx;L=aa*C.iy+L*C.jy+C.ty;U=Z*C.ix+J*C.jx+C.tx;J=Z*C.iy+J*C.jy+C.ty;R=Y*C.ix+i*C.jx+C.tx;i=Y*C.iy+i*C.jy+C.ty}var Q=x.vpointer;if(V===g){x.vdata[Q]=X;x.vdata[Q+1]=M;x.vdata[Q+2]=0;x.vdata[Q+3]=0;x.vdata[Q+4]=W;x.vdata[Q+5]=L;x.vdata[Q+6]=1;x.vdata[Q+7]=0;x.vdata[Q+8]=U;x.vdata[Q+9]=J;x.vdata[Q+10]=1;x.vdata[Q+11]=1;x.vdata[Q+12]=R;x.vdata[Q+13]=i;x.vdata[Q+14]=0;x.vdata[Q+15]=1}else{x.vdata[Q]=X;x.vdata[Q+1]=M;x.vdata[Q+2]=V;x.vdata[Q+3]=K;x.vdata[Q+4]=W;x.vdata[Q+5]=L;x.vdata[Q+6]=T;x.vdata[Q+7]=K;x.vdata[Q+8]=U;x.vdata[Q+9]=J;x.vdata[Q+10]=T;x.vdata[Q+11]=I;x.vdata[Q+12]=R;x.vdata[Q+13]=i;x.vdata[Q+14]=V;x.vdata[Q+15]=I}}function n(J){if(J.texture!==g&&J.texture!==null){return}J.texture=A.createTexture();var K=(typeof(CFG_MOJO_IMAGE_FILTERING_ENABLED)==="undefined"||CFG_MOJO_IMAGE_FILTERING_ENABLED==="true"||CFG_MOJO_IMAGE_FILTERING_ENABLED==="1");if(J.width>F.maxTextureSize||J.height>F.maxTextureSize){var I=document.createElement("canvas");I.width=(J.width>F.maxTextureSize)?F.maxTextureSize:J.width;I.height=(J.height>F.maxTextureSize)?F.maxTextureSize:J.height;var i=I.getContext("2d");i.drawImage(J,0,0,J.width,J.height,0,0,I.width,I.height);J=I}A.bindTexture(A.TEXTURE_2D,J.texture);A.texImage2D(A.TEXTURE_2D,0,A.RGBA,A.RGBA,A.UNSIGNED_BYTE,J);A.texParameteri(A.TEXTURE_2D,A.TEXTURE_WRAP_S,A.CLAMP_TO_EDGE);A.texParameteri(A.TEXTURE_2D,A.TEXTURE_WRAP_T,A.CLAMP_TO_EDGE);if(K){A.texParameteri(A.TEXTURE_2D,A.TEXTURE_MAG_FILTER,A.LINEAR)}else{A.texParameteri(A.TEXTURE_2D,A.TEXTURE_MAG_FILTER,A.NEAREST)}if(m(J.width)&&m(J.height)){if(K){A.texParameteri(A.TEXTURE_2D,A.TEXTURE_MIN_FILTER,A.LINEAR_MIPMAP_LINEAR);A.generateMipmap(A.TEXTURE_2D)}else{A.texParameteri(A.TEXTURE_2D,A.TEXTURE_MIN_FILTER,A.NEAREST_MIPMAP_NEAREST);A.generateMipmap(A.TEXTURE_2D)}}else{if(K){A.texParameteri(A.TEXTURE_2D,A.TEXTURE_MIN_FILTER,A.LINEAR)}else{A.texParameteri(A.TEXTURE_2D,A.TEXTURE_MIN_FILTER,A.NEAREST)}}}function m(i){return i>0&&((i-1)&i)===0}function j(i,J,I){this.type=i;this.count=J;this.texture=I}};function f(i){if(window.WebGLRenderingContext!==g){try{new d(document.getElementById(i))}catch(h){}}}};mojoHtml5Gl();